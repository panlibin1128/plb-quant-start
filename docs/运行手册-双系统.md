# A股筛选双系统运行手册（趋势 + 反转）

本文档用于记录当前项目的两套模式逻辑、关键参数和下次复现运行方法。

目标：下次无论是谁（包括我）接手，只看本文档就知道怎么跑、看哪里、怎么调参数。

---

## 1. 两个模式的逻辑思路

### 1.1 趋势模式（trend）

- 目标：筛选处于中长期上升结构、且相对强势的标的。
- 核心流程：
  1. 大盘过滤（HS300）
  2. 行业强度过滤
  3. 每行业市值TopN候选
  4. 趋势轨道条件（MA、HHV、RPS120+RPS250）
  5. 风险标记
- 入口命令：`--system trend`

### 1.2 反转模式（reversal）

- 目标：筛选“月线反转 5.0”条件的个股。
- 核心条件（`src/reversal_system.py`）：
  - `A`: `close > MA250`
  - `B`: 近30天内出现过50天新高
  - `D`: `RPS50 > rps50_threshold`
  - `AA`: 近30天站上MA250天数在 `(2,30)`
  - `AB`: `high / HHV120 > near_120d_high_threshold`
  - 最终：`reversal_signal = A & B & D & AA & AB`
- 入口命令：`--system reversal`

---

## 2. 常用运行方式（下次直接照抄）

默认环境（项目根目录）：`/mnt/e/akshare`

### 2.1 仅趋势

```bash
.venv/bin/python -m src.main --date today --config config.yaml --system trend
```

### 2.2 仅反转（默认阈值）

```bash
.venv/bin/python -m src.main --date today --config config.yaml --system reversal
```

### 2.3 仅反转（RPS50阈值=80）

```bash
.venv/bin/python -m src.main --date today --config config.reversal80.yaml --system reversal
```

### 2.4 双系统一起跑

```bash
.venv/bin/python -m src.main --date today --config config.yaml --system both
```

---

## 3. 输出文件和命名约定

程序默认输出到 `outputs/`：

- `YYYY-MM-DD_candidates.csv`
- `YYYY-MM-DD_summary.json`

为了让结果语义清晰，建议运行后复制为模式化命名：

### 3.1 仅反转命名

```bash
RUN_DATE=$(date +%F)
cp "outputs/${RUN_DATE}_candidates.csv" "outputs/${RUN_DATE}_reversal_only_candidates.csv"
cp "outputs/${RUN_DATE}_summary.json" "outputs/${RUN_DATE}_reversal_only_summary.json"
```

### 3.2 反转80阈值命名

```bash
RUN_DATE=$(date +%F)
cp "outputs/${RUN_DATE}_candidates.csv" "outputs/${RUN_DATE}_reversal80_candidates.csv"
cp "outputs/${RUN_DATE}_summary.json" "outputs/${RUN_DATE}_reversal80_summary.json"
```

---

## 4. 关键参数（影响数量）

配置文件：`config.yaml`、`config.reversal80.yaml`

### 4.1 反转数量最敏感参数

- `reversal_params.rps50_threshold`
  - 默认：`85`
  - 降低该值会增加候选（80是当前已验证可用档）

### 4.2 次敏感参数

- `reversal_params.near_120d_high_threshold`
  - 默认：`0.9`
  - 降低会增加候选，但通常不如RPS阈值敏感

### 4.3 候选池规模参数

- `run.top_n_per_industry`（industry_top3模式下有效）
- `run.min_turnover`
- `reversal_universe_mode`（`industry_top3` / `all_a`）

---

## 5. 每次运行后最少检查项

### 5.1 看summary

```bash
.venv/bin/python - <<'PY'
import json
from pathlib import Path
p = Path('outputs')
run_date = __import__('datetime').datetime.now().strftime('%Y-%m-%d')
s = json.loads((p / f'{run_date}_summary.json').read_text(encoding='utf-8'))
print('system_mode:', s.get('system_mode'))
print('reversal_signals:', s.get('reversal_signals'))
print('signal_label_counts:', s.get('signal_label_counts'))
PY
```

### 5.2 看反转命中公司数（去重）

```bash
.venv/bin/python - <<'PY'
import pandas as pd
from datetime import datetime
run_date = datetime.now().strftime('%Y-%m-%d')
df = pd.read_csv(f'outputs/{run_date}_candidates.csv')
hit = df[df['reversal_signal'] == True]
print('hit_rows:', len(hit))
print('hit_unique_symbols:', hit['symbol'].nunique())
PY
```

---

## 6. 本次已验证结论（便于下次快速决策）

- `rps50_threshold: 85` 时：反转命中行数约 `16`，去重公司约 `5`。
- `rps50_threshold: 80` 时：反转命中行数约 `18`，去重公司约 `7`。
- 说明：80 相比 85 是“轻微放宽且有效增加数量”的档位。

---

## 7. 一句话操作指南（下次直接做）

如果你想要“比85稍微多一点”的反转结果，直接运行：

```bash
.venv/bin/python -m src.main --date today --config config.reversal80.yaml --system reversal
```

然后把输出重命名为 `reversal80` 版本（见第3.2节）。
