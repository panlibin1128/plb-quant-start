行，**主体不改**（“大盘过滤 → 行业强度 → 行业前三 → 顺向火车轨 → 风控退出” 这条主线完全保留），我帮你做两件事：

1. 把每一层**变成更可执行、更少歧义**的规则（但不改变结构）
2. 给你一段**可以直接丢给 Codex 的提示词**：从 0 环境（WSL2 Ubuntu）开始，自动搭环境 + 拉数据 + 跑筛选 + 输出结果

---

## 1) 在不改主体的前提下，优化成“可落地”的版本

### 层1：大盘趋势过滤（Market Regime）

**目的：只在“适合趋势”的市场做趋势系统。**

* 过滤条件（满足其一即可）

  * 沪深300：`Close > MA250`
  * 或 沪深300：`MA20 > MA60`
  * 或 过去20日收益 > 0 且 波动不极端（可选）

> 解释：你原来“指数在年线/均线向上”的表达更明确了。

---

### 层2：行业强度过滤（Industry Strength）

**目的：只做强行业。**

* 行业强度指标（满足其一即可）

  * 行业指数：`Close > MA120`
  * 或 行业指数：近60日相对沪深300超额收益为正
  * 或 行业指数RPS（如果能拿到行业指数历史）

> 如果你暂时拿不到“行业指数”历史，就用“行业内股票平均收益 vs 沪深300”的替代强度（实现更稳）。

---

### 层3：行业前三（Top-3 Leaders）

**目的：只在行业里选龙头。**

**固定定义（建议你就用这一条，最省事、客观）：**

* 按“总市值”排序取前三（可加流动性过滤：成交额Top N、剔除ST）

> 你不需要在“市占率/营收/利润”里纠结，先用市值最落地。

---

### 层4：顺向火车轨（Trend Core，不改你主体）

这里把“陶博士”这套规则**一字不改含义**地量化成布尔条件：

* **RPS动量（保留主体）**

  * `RPS120 + RPS250 > 185`
  * 备注：RPS = 同一交易日、全市场横截面收益排名百分位（0~100）

* **长期趋势持续性（保留主体）**

  * `COUNT(C > MA250, 30) >= 25`
  * `COUNT(C > MA200, 30) >= 25`
  * `COUNT(C > MA20, 10)  >= 9`

* **接近一年新高（保留主体）**

  * `C / HHV(C, 250) > 0.8`（0.8可调0.75~0.85）

* **均线顺向结构（保留主体）**

  * `EVERY(MA20 >= REF(MA20,1), 5)`（MA20 连续5天不下降）
  * `EVERY(MA10 >= MA20, 5)`（10日线连续5天在20日线上方）

---

### 层5：风控退出（不改主体，但补齐“怎么退出”）

你原来只有“买入逻辑”，我补齐成可执行规则（不改变你主体，只是完善）：

* **减仓**：`Close < MA20` 连续2天
* **清仓**：`Close < MA60` 或 从最高点回撤 > 12%
* **止盈保护**（可选）：盈利后跌破 MA20 清仓一半

> 趋势系统能不能长期跑，80%靠“退出”。

---

## 2) 给 Codex 的提示词（从 0 到可跑）

下面这段你直接复制给 Codex 就行（它会在 WSL2 Ubuntu 给你搭环境并写代码）。
我按“你没任何量化环境”的现实做了：**用 AkShare（免token）+ pandas**，先把系统跑通。
并且对 “RPS” 给了两种实现：**严格RPS**（全市场横截面，耗时）和 **快速RPS代理**（相对沪深300的120/250日超额收益分位，速度快）。

> 你先跑“快速版”，能出结果后再决定要不要上“严格版”。

```text
你是资深量化工程师。请在 WSL2 Ubuntu（用户无任何量化环境）从零搭建一个可运行项目，用 AkShare 获取A股公开行情数据，实现“行业前三 + 顺向火车轨”选股系统。主体结构不得改变：大盘过滤 → 行业强度 → 行业前三 → 顺向火车轨 → 风控规则。目标是每日输出候选股列表CSV与日志。

【项目目标】
1) 自动创建 Python 虚拟环境 .venv 并安装依赖：akshare, pandas, numpy, tqdm, pyarrow(可选), matplotlib(可选), pyyaml
2) 用 AkShare 拉取A股实时列表（东方财富）包含：代码、名称、总市值、成交额、行业/板块字段（若有）、是否ST（若可得）
3) 支持两种行业定义方式（可在 config.yaml 选择）：
   A. 使用东方财富“行业”字段（若 akshare spot 数据自带行业）
   B. 若缺行业字段，则用用户传入的行业成分列表CSV（industry, symbol）作为兜底（代码要支持，但默认用A）
4) 行业前三：按总市值排序取前三；同时过滤 ST、成交额过低（阈值可配置）
5) 大盘过滤：默认用沪深300（symbol=sh000300）日线，条件 Close>MA250 或 MA20>MA60（二选一）
6) 行业强度过滤：
   - 若能拿到行业指数日线：行业指数 Close>MA120 或 行业指数近60日收益 - 沪深300近60日收益 > 0
   - 若拿不到行业指数：用行业前三股票的等权近60日收益作为行业代理，与沪深300比较
7) 顺向火车轨条件（对个股日线）：
   - MA10, MA20, MA60, MA200, MA250 计算
   - COUNT(C>MA250,30)>=25
   - COUNT(C>MA200,30)>=25
   - COUNT(C>MA20,10)>=9
   - C/HHV(C,250) > 0.8（阈值可配置 0.75~0.85）
   - EVERY(MA20>=REF(MA20,1),5)  （MA20连续5天不下降）
   - EVERY(MA10>=MA20,5)         （MA10连续5天在MA20上）
   - RPS条件：RPS120 + RPS250 > 185（阈值可配置 180~185）
     * 必须实现两种 RPS 模式（config选择）：
       (1) fast_proxy: 用“相对沪深300的120/250日超额收益”在候选池内做分位数映射到0-100，作为RPS代理（默认）
       (2) strict_market: 全A股横截面：对每个交易日计算120/250日收益排名百分位映射为0-100（注意性能与缓存；可以只计算最新一天的RPS以先落地）
8) 输出：
   - outputs/YYYY-MM-DD_candidates.csv：包含行业、代码、名称、市值、成交额、各条件是否满足、最终信号
   - outputs/YYYY-MM-DD_summary.json：统计每一步过滤剩余数量
   - logs/run.log
9) 工程要求：
   - 代码结构：src/ 下模块化（data_fetch.py, indicators.py, filters.py, rps.py, main.py）
   - 支持缓存：data_cache/ 保存历史日线（parquet或csv），避免重复下载
   - 加入速率限制与断点续跑：避免被封（sleep + 重试）
   - 提供 README.md：一步步教用户在WSL2运行（python -m venv, pip install, python -m src.main --date today）

【数据接口建议（AkShare）】
- 沪深300指数日线：ak.index_zh_a_hist(symbol="000300", period="daily") 或 ak.stock_zh_index_daily_em("sh000300")（择一可用的）
- A股列表与市值成交额：ak.stock_zh_a_spot_em()
- 个股日线：ak.stock_zh_a_hist(symbol="600031", period="daily", adjust="qfq")（注意 symbol 需要纯数字）
如果某接口不可用，允许自动切换到备用接口并写日志说明。

【交付】
- 直接在当前目录创建完整项目文件
- 写好可运行命令示例
- 最后输出：如何运行、输出文件在哪里、如何切换 strict_market RPS

现在开始执行，先生成文件结构与 config.yaml，再写代码，然后做一次最小自检（比如拉沪深300最近300天并计算均线成功）。
```

---

