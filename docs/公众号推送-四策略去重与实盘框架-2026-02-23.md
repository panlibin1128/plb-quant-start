# A股日筛系统 V1 首发：四策略框架、参数细节与实盘口径（含去重机制）

这篇是本公众号第一篇策略工程文，目标不是“讲故事”，而是把系统讲清楚：

- 系统到底做了什么
- 每个策略的核心逻辑和参数含义
- 为什么会出现重复股票，怎么修复
- 现在每天产出的文件该怎么读

本文基于仓库当前版本（2026-02-23）整理。

---

## 一、系统总览：四策略并行，统一入口

系统当前包含 4 套策略，统一由 `src/main.py` 调度：

1. `trend`（趋势策略）
2. `reversal`（反转策略）
3. `score`（趋势打分策略）
4. `value`（价值策略）

统一流程是：

1. 大盘状态过滤（HS300）
2. 全市场快照（spot）
3. 行业内筛选（按流动性 + 市值）
4. 历史行情拉取与指标计算
5. 分策略独立产出 CSV + summary

当前输出已统一成“一股一行”（按 `symbol` 唯一），避免同一股票多行业映射造成重复计数。

---

## 二、全局参数（跨策略共用）

以下参数来自 `config.quick.yaml` / `config.value_v1.yaml`：

- `run.min_turnover=300000000`
  - 最低成交额门槛（过滤流动性过差标的）
- `run.top_n_per_industry=3`
  - 每个行业按总市值保留前 3 只
- `market_filter.use_close_gt_ma250=true`
- `market_filter.use_ma20_gt_ma60=true`
  - 大盘环境门槛，至少满足其一
- `industry_strength.mode=auto`
  - 行业强度自动选择代理法或行业指数法
- `rps.mode=fast_proxy`
  - 使用快速代理 RPS（效率优先）

这组参数决定了策略输入池的规模和风格：偏主流、偏流动性、偏趋势环境。

---

## 三、策略逻辑细节（核心）

## 1) Trend（趋势策略）

### 逻辑来源

核心函数：`filters.trend_train_track_flags(...)`

趋势信号 `final_signal` 由 7 个条件同时满足：

1. 近 30 天中，`close > MA250` 的天数 >= 25
2. 近 30 天中，`close > MA200` 的天数 >= 25
3. 近 10 天中，`close > MA20` 的天数 >= 9
4. `HHV_RATIO(250) > trend.hhv_ratio_threshold`（默认 0.8）
5. MA20 最近 5 天单调不降
6. MA10 最近 5 天持续 >= MA20
7. `rps120 + rps250 > trend.rps_sum_threshold`（默认 185）

### 风险附加列

同时输出风控辅助信号：

- `risk_reduce`（是否减仓）
- `risk_exit_ma60`（是否跌破 MA60 退出）
- `risk_drawdown` / `risk_exit_drawdown`

### 输出口径

- `trend_candidates.csv` 仅保留 `final_signal=true`
- 并按 `symbol` 去重（一股一行）

---

## 2) Reversal（反转策略）

### 逻辑来源

核心函数：`reversal_system.evaluate_reversal_stock(...)`

反转信号由条件 `A & B & D & AA & AB` 构成：

- `A`: `close > MA250`
- `B`: 近 30 天至少有 1 天创 50 日新高
- `D`: `rps50 > reversal_params.rps50_threshold`
  - 默认 85，`config.reversal80.yaml` 下为 80
- `AA`: 近 30 天在 MA250 上方天数 > 2 且 < 30
- `AB`: `high / HHV120 > near_120d_high_threshold`（默认 0.9）

### 额外字段

- `reversal_first_in_30d`：近 30 天首次反转触发
- `reversal_rps50`：反转用强度值

### 输出口径

- `reversal_candidates.csv` 仅保留 `reversal_signal=true`
- 并按 `symbol` 去重

---

## 3) Score（趋势打分策略）

### 逻辑来源

核心函数：`score_system.run_score(...)`

总分由 5 个子分 + 风险扣分构成：

- `score_trend`：均线位置与斜率（MA50/MA250）
- `score_structure`：局部高低点结构（高点抬高、低点抬高）
- `score_volume`：放量突破与后续承接
- `score_strength`：相对基准超额收益分位（63/21）
- `score_pullback`：回踩质量（回撤幅度、量价配合、MA50承接）
- `risk_penalty`：异常风险扣分（churn / upper_shadow / breakdown）

总分字段：`score_total`

### 关键参数（score段）

- `top_n_output=30`
- `slope_lookback=10`
- `structure_lookback=60`
- `breakout_high_lookback=60`
- `breakout_volume_mult=1.5`
- `strength_full_score_percentile=80`
- `enable_extension_filter=true`
- `extension_ratio_threshold=1.25`
- `extension_pullback_penalty=5`

### 输出口径

- 先按 `score_total/score_strength/score_trend` 降序
- 再按 `symbol` 去重
- 最后取 Top30

---

## 4) Value（价值策略）

### 逻辑来源

核心函数：`value_system.run_value(...)`

流程：

1. 行业白名单过滤（生产资料方向）
2. 财务门槛过滤（PE/PB/ROE/分红/现金流）
3. 价值分计算并排序

价值总分公式：

- `value_score_dividend = 0.4 * dividend_percentile`
- `value_score_pe = 0.3 * (1 - pe_percentile)`
- `value_score_pb = 0.2 * (1 - pb_percentile)`
- `value_score_roe = 0.1 * roe_percentile`
- `value_score_total = 上述四项之和`

### 保守降级机制（重点）

为解决 A 股财务字段缺失，策略支持“保守降级，不放水”：

- Level0：严格模式
- Level1：允许保守替代
- Level2：仅在结果为空时启用更严替代

替代标签会显式写入：

- `missing_roe_used_proxy`
- `missing_ocf_ratio_used_debt_guard`
- `missing_dividend`
- `earnings_data_missing`

并在结果列输出：

- `degrade_level`
- `missing_fields`
- `replacement_tags`

### V1 与 V2 参数差异（核心）

V1（保守，`config.value_v1.yaml`）：

- `max_pe=30`
- `max_pb=3.0`
- `min_roe=0.10`
- `min_dividend_yield=0.03`
- `min_operating_cf_ratio=0.8`

V2（更激进，`config.value_v2.yaml`）：

- `max_pe=35`
- `max_pb=3.5`
- `min_roe=0.08`
- `min_dividend_yield=0.02`
- `min_operating_cf_ratio=0.6`

---

## 四、为什么必须统一“去重口径”？

### 问题根因

同一股票在原始数据里可能绑定多个行业标签（one-to-many），若直接 merge 或分组筛选，容易生成重复行。

重复行会带来 3 个问题：

1. 一个股票在候选池“占多个名额”
2. TopN 被重复项挤占，真实覆盖下降
3. 回测统计口径不稳定（同一天数量波动异常）

### 当前修复原则

- 输出层统一按 `symbol` 唯一化
- `score/value` 在排序后先去重再截断 TopN
- `reversal` 增加 key 唯一化与 merge 校验（one-to-one 约束）
- 保留 `industry_tags` 聚合信息，避免“去重=丢信息”

---

## 五、2026-02-23 实跑结果（唯一股票口径）

在当前缓存与市场状态下，当日输出：

- `trend`: 9 只
- `reversal`: 3 只
- `score`: 30 只（Top30）
- `value`: 5 只

说明：

- 与旧版本相比，数量下降主要来自“重复计数被清理”
- 这是口径修正，不是策略退化

---

## 六、输出文件与重点列（实战）

### 1) Trend

- 文件：`YYYY-MM-DD_trend_candidates.csv`
- 必看：`symbol`, `name`, `industry`, `final_signal`, `rps120`, `rps250`, `risk_exit_ma60`

### 2) Reversal

- 文件：`YYYY-MM-DD_reversal_candidates.csv`
- 必看：`symbol`, `name`, `reversal_signal`, `reversal_rps50`, `reversal_first_in_30d`

### 3) Score

- 文件：`YYYY-MM-DD_score_candidates.csv`
- 必看：`score_total`, `risk_flags`, `score_reason_top3`, `risk_reason`

### 4) Value

- 文件：`YYYY-MM-DD_value_candidates.csv`
- 必看：`value_score_total`, `risk_flags_value`, `degrade_level`, `replacement_tags`

---

## 七、如何运行（给读者的可复现命令）

```bash
# 趋势
python -m src.main --date today --config config.quick.yaml --system trend

# 反转（默认阈值）
python -m src.main --date today --config config.quick.yaml --system reversal

# 反转（RPS50阈值=80）
python -m src.main --date today --config config.reversal80.yaml --system reversal

# 打分
python -m src.main --date today --config config.quick.yaml --system score

# 价值V1（保守）
python -m src.main --date today --config config.value_v1.yaml --system value

# 价值V2（更激进）
python -m src.main --date today --config config.value_v2.yaml --system value

# 四策略联动
python -m src.main --date today --config config.value_v1.yaml --system both
```

---

## 八、这套系统现在适合怎么用？

实战建议是三层联动：

1. `trend + reversal` 负责信号发现
2. `score` 负责交易优先级排序
3. `value` 负责估值与基本面约束

一句话：

- 先看“有没有机会”（trend/reversal）
- 再看“机会谁更优”（score）
- 最后看“值不值得承受风险”（value）

---

## 九、后续迭代方向

下一阶段我们会做两件事：

1. 在唯一口径下继续提升命中质量（减少噪音）
2. 在不放水前提下优化 value 覆盖率（强化可用性）

---

> 免责声明：本文仅用于策略研究与工程记录，不构成任何投资建议。
